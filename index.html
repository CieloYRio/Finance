<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prospira Finance Management System 2025</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#3b82f6',
                        accent: '#0ea5e9',
                        success: '#059669',
                        warning: '#d97706',
                        danger: '#dc2626',
                        dark: '#1f2937',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
        }
        .editable-cell { 
            cursor: pointer; 
            transition: all 0.2s ease;
        }
        .editable-cell:hover { 
            background-color: #f1f5f9; 
            transform: translateY(-1px);
        }
        .editing { 
            background-color: #dbeafe !important; 
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .metric-card {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            box-shadow: 0 10px 30px rgba(30, 64, 175, 0.3);
            transition: transform 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .sidebar {
            background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
            min-height: 100vh;
            width: 280px;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e1e7ef 100%);
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            margin: 4px 12px;
            border-radius: 12px;
            color: #9ca3af;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .nav-item:hover, .nav-item.active {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            transform: translateX(5px);
        }
        .nav-item i {
            width: 20px;
            margin-right: 12px;
        }
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="font-sans bg-light">
    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-xl font-bold text-white">Prospira</h1>
            <p class="text-gray-400 text-sm mt-1">Simplifying Finance for Growth and Clarity</p>
            
            <!-- Company Section -->
            <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-400 uppercase tracking-wide">Company</p>
                        <p class="text-white font-medium" id="companyName">Click to set company name</p>
                    </div>
                    <button onclick="editCompanyName()" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fas fa-edit text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="py-6">
            <a href="#" class="nav-item active" onclick="showTab('dashboard')">
                <i class="fas fa-chart-line"></i>
                Dashboard
            </a>
            <a href="#" class="nav-item" onclick="showTab('project-profile')">
                <i class="fas fa-project-diagram"></i>
                Project Profile
            </a>
            <a href="#" class="nav-item" onclick="showTab('reference-table')">
                <i class="fas fa-table"></i>
                Reference Table
            </a>
            <a href="#" class="nav-item" onclick="showTab('transaction-masters')">
                <i class="fas fa-exchange-alt"></i>
                Transaction Masters
            </a>
            <a href="#" class="nav-item" onclick="showTab('collections-master')">
                <i class="fas fa-coins"></i>
                Collections Master
            </a>
            <a href="#" class="nav-item" onclick="showTab('overhead-summary')">
                <i class="fas fa-chart-pie"></i>
                Overhead Summary
            </a>
            <a href="#" class="nav-item" onclick="showTab('project-revenue')">
                <i class="fas fa-money-bill-wave"></i>
                Project Revenue
            </a>
            <a href="#" class="nav-item" onclick="showTab('budget-actual')">
                <i class="fas fa-balance-scale"></i>
                Budget vs Actual
            </a>
            <a href="#" class="nav-item" onclick="showTab('project-cost')">
                <i class="fas fa-calculator"></i>
                Project Cost
            </a>
            <a href="#" class="nav-item" onclick="showTab('accounts-receivable')">
                <i class="fas fa-file-invoice-dollar"></i>
                Accounts Receivable
            </a>
            <a href="#" class="nav-item" onclick="showTab('cash-flow')">
                <i class="fas fa-water"></i>
                Cash Flow
            </a>
            <a href="#" class="nav-item" onclick="showTab('profit-loss')">
                <i class="fas fa-chart-bar"></i>
                Profit & Loss
            </a>
            <a href="#" class="nav-item" onclick="showTab('accounts-payable')">
                <i class="fas fa-file-invoice"></i>
                Accounts Payables
            </a>
            <a href="#" class="nav-item" onclick="showTab('fixed-assets')">
                <i class="fas fa-building"></i>
                Fixed Assets
            </a>
            <a href="#" class="nav-item" onclick="showTab('owners-capital')">
                <i class="fas fa-user-tie"></i>
                Owners' Capital
            </a>
            <a href="#" class="nav-item" onclick="showTab('owners-liability')">
                <i class="fas fa-clipboard-list"></i>
                Owners Liability
            </a>
            <a href="#" class="nav-item" onclick="showTab('balance-sheet')">
                <i class="fas fa-balance-scale-right"></i>
                Balance Sheet
            </a>
            <a href="#" class="nav-item" onclick="showTab('trial-balance')">
                <i class="fas fa-calculator"></i>
                Trial Balance
            </a>
            <a href="#" class="nav-item" onclick="showTab('general-ledger')">
                <i class="fas fa-book"></i>
                General Ledger
            </a>
            <a href="#" class="nav-item" onclick="showTab('journal-entries')">
                <i class="fas fa-edit"></i>
                Journal Entries
            </a>
            <a href="#" class="nav-item" onclick="showTab('financial-reports')">
                <i class="fas fa-chart-area"></i>
                Financial Reports
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="glass-card border-b p-6 sticky top-0 z-50">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button onclick="toggleSidebar()" class="lg:hidden mr-4 p-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" id="pageTitle">Dashboard</h2>
                        <p class="text-gray-600 text-sm">Real-time financial insights and analytics</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="importExcel()" class="bg-success hover:bg-green-600 text-white px-6 py-3 rounded-xl flex items-center gap-2 shadow-lg transition-all duration-300 hover:shadow-xl">
                        <i class="fas fa-file-import"></i>
                        Import Excel
                    </button>
                    <button onclick="exportExcel()" class="bg-primary hover:bg-indigo-600 text-white px-6 py-3 rounded-xl flex items-center gap-2 shadow-lg transition-all duration-300 hover:shadow-xl">
                        <i class="fas fa-file-export"></i>
                        Export Excel
                    </button>
                </div>
            </div>
        </header>

        <!-- Tab Content -->
        <main class="p-6">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm font-medium">Total Revenue</p>
                                <p class="text-3xl font-bold mt-2" id="totalRevenue">₱0.00</p>
                            </div>
                            <i class="fas fa-chart-line text-3xl text-white/60"></i>
                        </div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm font-medium">Total Collections</p>
                                <p class="text-3xl font-bold mt-2" id="totalCollections">₱0.00</p>
                            </div>
                            <i class="fas fa-coins text-3xl text-white/60"></i>
                        </div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm font-medium">Total Expenses</p>
                                <p class="text-3xl font-bold mt-2" id="totalExpenses">₱0.00</p>
                            </div>
                            <i class="fas fa-credit-card text-3xl text-white/60"></i>
                        </div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm font-medium">Net Profit</p>
                                <p class="text-3xl font-bold mt-2" id="netProfit">₱0.00</p>
                            </div>
                            <i class="fas fa-trophy text-3xl text-white/60"></i>
                        </div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Revenue vs Profit Trend</h3>
                        <div class="chart-container">
                            <canvas id="revenueProfitChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Monthly Net Profit</h3>
                        <div class="chart-container">
                            <canvas id="monthlyProfitChart"></canvas>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Project Performance</h3>
                        <div class="chart-container">
                            <canvas id="budgetActualChart"></canvas>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">500 Series Cost Breakdown</h3>
                        <div class="chart-container">
                            <canvas id="costBreakdownChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Outstanding Items -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Outstanding Receivables</h3>
                        <div class="text-3xl font-bold text-success" id="outstandingReceivables">₱0.00</div>
                        <p class="text-gray-600 mt-2">Pending collections from clients</p>
                    </div>
                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Outstanding Payables</h3>
                        <div class="text-3xl font-bold text-danger" id="outstandingPayables">₱0.00</div>
                        <p class="text-gray-600 mt-2">Pending payments to vendors</p>
                    </div>
                </div>
            </div>

            <!-- Project Profile Tab -->
            <div id="project-profile" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Project Profile</h2>
                        <button onclick="addProject()" class="bg-primary hover:bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg transition-all duration-300">
                            <i class="fas fa-plus mr-2"></i>Add Project
                        </button>
                    </div>
                    
                    <div id="projectCards" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Project cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Reference Table Tab -->
            <div id="reference-table" class="tab-content">
                <div class="space-y-6">
                    <!-- COA Section -->
                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Chart of Accounts (BIR-Aligned)</h3>
                            <button onclick="addCOA()" class="bg-primary text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-plus mr-2"></i>Add Account
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Old COA</th>
                                        <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Unified Code</th>
                                        <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Account Name</th>
                                        <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Category</th>
                                        <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Subcategory</th>
                                        <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="coaTable">
                                    <!-- COA entries will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 500 Series Project Expenses -->
                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">500 Series Project Expenses</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="projectExpensesList">
                            <!-- Project expenses will be populated here -->
                        </div>
                    </div>

                    <!-- Operating Funds -->
                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Operating Funds</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="operatingFundsList">
                            <!-- Operating funds will be populated here -->
                        </div>
                    </div>

                    <!-- Expense Categories -->
                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Expense Categories</h3>
                        <div class="space-y-4" id="expenseCategoriesList">
                            <!-- Expense categories will be populated here -->
                        </div>
                    </div>

                    <!-- Project Types & Status -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass-card rounded-2xl p-6 shadow-xl">
                            <h3 class="text-lg font-semibold mb-4 text-gray-800">Project Types</h3>
                            <div class="space-y-2" id="projectTypesList">
                                <!-- Project types will be populated here -->
                            </div>
                        </div>
                        
                        <div class="glass-card rounded-2xl p-6 shadow-xl">
                            <h3 class="text-lg font-semibold mb-4 text-gray-800">Project Status</h3>
                            <div class="space-y-3" id="projectStatusList">
                                <!-- Project status will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Client Billing Types -->
                    <div class="glass-card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Client Billing Types (Revenue Milestones)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="billingTypesList">
                            <!-- Billing types will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction Masters Tab -->
            <div id="transaction-masters" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Transaction Masters</h2>
                        <button onclick="addTransaction()" class="bg-primary hover:bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Add Transaction
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Payment Date</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Particulars</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Expense Type</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Unified Code</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Project ID</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Vendor</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Total Amount</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Paid</th>
                                </tr>
                            </thead>
                            <tbody id="transactionTable">
                                <!-- Transactions will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Collections Master Tab -->
            <div id="collections-master" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Collections Master</h2>
                        <button onclick="addCollection()" class="bg-success hover:bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Add Collection
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Date</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Client Name</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Project ID</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Project Name</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Invoice Number</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Amount Received</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Payment Method</th>
                                </tr>
                            </thead>
                            <tbody id="collectionTable">
                                <!-- Collections will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Overhead Summary Tab -->
            <div id="overhead-summary" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Overhead Summary</h2>
                    <div id="overheadSummaryContent">
                        <!-- Overhead data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Project Revenue Tab -->
            <div id="project-revenue" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Project Revenue</h2>
                    <div id="projectRevenueContent">
                        <!-- Project revenue data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Budget vs Actual Tab -->
            <div id="budget-actual" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Budget vs Actual</h2>
                    <div id="budgetActualContent">
                        <!-- Budget vs actual data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Project Cost Tab -->
            <div id="project-cost" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Project Cost</h2>
                    <div id="projectCostContent">
                        <!-- Project cost data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Accounts Receivable Tab -->
            <div id="accounts-receivable" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Accounts Receivable</h2>
                    <div id="accountsReceivableContent">
                        <!-- Accounts receivable data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Cash Flow Tab -->
            <div id="cash-flow" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Cash Flow</h2>
                    <div id="cashFlowContent">
                        <!-- Cash flow data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Profit & Loss Tab -->
            <div id="profit-loss" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Profit & Loss Statement</h2>
                    <div id="profitLossContent">
                        <!-- P&L data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Accounts Payable Tab -->
            <div id="accounts-payable" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Accounts Payables</h2>
                    <div id="accountsPayableContent">
                        <!-- Accounts payable data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Fixed Assets Tab -->
            <div id="fixed-assets" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Fixed Assets</h2>
                    <div class="flex justify-between items-center mb-6">
                        <div></div>
                        <button onclick="addFixedAsset()" class="bg-primary hover:bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Add Fixed Asset
                        </button>
                    </div>
                    <div id="fixedAssetsContent">
                        <!-- Fixed assets data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Owners' Capital Tab -->
            <div id="owners-capital" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Owners' Capital</h2>
                    <div class="flex justify-between items-center mb-6">
                        <div></div>
                        <button onclick="addCapitalEntry()" class="bg-primary hover:bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Add Capital Entry
                        </button>
                    </div>
                    <div id="ownersCapitalContent">
                        <!-- Owners' capital data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Owners Liability Tab -->
            <div id="owners-liability" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Owners Liability</h2>
                    <div class="flex justify-between items-center mb-6">
                        <div></div>
                        <button onclick="addLiabilityEntry()" class="bg-primary hover:bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Add Liability Entry
                        </button>
                    </div>
                    <div id="ownersLiabilityContent">
                        <!-- Owners' liability data will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Balance Sheet Tab -->
            <div id="balance-sheet" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Balance Sheet</h2>
                    <div id="balanceSheetContent">
                        <!-- Balance sheet will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Trial Balance Tab -->
            <div id="trial-balance" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Trial Balance</h2>
                    <div id="trialBalanceContent">
                        <!-- Trial balance will be populated here -->
                    </div>
                </div>
            </div>

            <!-- General Ledger Tab -->
            <div id="general-ledger" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">General Ledger</h2>
                    <div id="generalLedgerContent">
                        <!-- General ledger will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Journal Entries Tab -->
            <div id="journal-entries" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Journal Entries</h2>
                    <div class="flex justify-between items-center mb-6">
                        <div></div>
                        <button onclick="addJournalEntry()" class="bg-primary hover:bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Add Journal Entry
                        </button>
                    </div>
                    <div id="journalEntriesContent">
                        <!-- Journal entries will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Financial Reports Tab -->
            <div id="financial-reports" class="tab-content">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Financial Reports</h2>
                    <div id="financialReportsContent">
                        <!-- Financial reports will be populated here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Auto-save notification -->
    <div id="autoSaveNotification" class="fixed bottom-4 right-4 bg-success text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-full transition-transform duration-300">
        <i class="fas fa-check-circle mr-2"></i>
        Data auto-saved
    </div>

    <!-- Hidden file input for Excel import -->
    <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelImport(event)">

    <script>
        // Global data storage with YOUR EXACT STRUCTURE
        let financeData = {
            companyName: 'Click to set company name',
            
            // YOUR REAL PROJECT MASTER DATA
            projectMaster: {
                'P0': { code: 'ART', fullId: 'P0-ART', clientName: 'Artopian', projectName: 'Design for an Office', projectType: 'Design', location: '' },
                'P1': { code: 'LEZ', fullId: 'P1-LEZ', clientName: 'Mrs. Lina Ecal', projectName: 'Constrcution of One Storey Stalls', projectType: 'Build', location: 'Botolan Zambales' },
                'P2': { code: 'RHL', fullId: 'P2-RHL', clientName: 'Ms. Rhea Hachac', projectName: 'Design for One Storey Coffee Shop', projectType: 'Design', location: 'Laguna' },
                'P3': { code: 'PRP', fullId: 'P3-PRP', clientName: 'Mr. Mel Patrick Roque', projectName: '48 sqm 2 Bedroom Unit Fit Out', projectType: 'Fit Out', location: 'Prisma Residences Pasig City' },
                'P4': { code: 'CRV', fullId: 'P4-CRV', clientName: 'Ms. Catheryn Sy Reyes', projectName: '74 sqm 3 bedroom House Interior Fit out', projectType: 'Fit Out', location: 'Vivace Imus Cavite' },
                'P5': { code: 'JDB', fullId: 'P5-JDB', clientName: 'Mr.  Jeffrey de Castro', projectName: '16.6 sqm Kitchen & Laundry Area Extension', projectType: 'Renovation', location: 'Binangonan Rizal' },
                'P6': { code: 'JVP', fullId: 'P6-JVP', clientName: 'Mr. Joseph Ryan Villar', projectName: '1 Bedroom Condo Unit Fit Out', projectType: 'Fit Out', location: 'Shore Residences Pasay City' },
                'P7': { code: 'IMP', fullId: 'P7-IMP', clientName: 'Mrs. Ivy Jhane Chavez Molina', projectName: 'Design for House Extension & Renovation', projectType: 'Design', location: 'Mexico Pampanga' },
                'P8': { code: 'BST', fullId: 'P8-BST', clientName: 'Mr. Benjo Sebuc', projectName: '1 Bedroom Condo Unit Fit Out', projectType: 'Fit Out', location: 'Grace Residences Taguig City' },
                'P9': { code: 'MOB', fullId: 'P9-MOB', clientName: 'Mr. Marco Oda', projectName: 'Design for 3 Bedroom House Interior', projectType: 'Design', location: 'San Juan Batangas' },
                'P10': { code: 'SSC', fullId: 'P10-SSC', clientName: 'Mr. Segundo Santua', projectName: 'Design for Residential Home', projectType: 'Design', location: 'Gen Trias Cavite' },
                'P11': { code: 'KCP', fullId: 'P11-KCP', clientName: 'Mr. Kent Cabarle', projectName: '23 sqm Condo  Unit Fit Out', projectType: 'Fit Out', location: 'Lumeire Pasig City' },
                'P12': { code: 'KOP', fullId: 'P12-KOP', clientName: 'Ms. Kassandra Obsum', projectName: '70 sqm Condo Fit Out', projectType: 'Fit Out', location: 'Prisma Pasig City' },
                'P13': { code: 'MCP', fullId: 'P13-MCP', clientName: 'Ms. Mia Coyoca', projectName: '26 sqm Condo Fit Out', projectType: 'Fit Out', location: 'Coast Residences Pasay City' },
                'P14': { code: 'VDC', fullId: 'P14-VDC', clientName: 'Ms. Vanessa DeLeon', projectName: 'Design for 3 Storey Commercial and Resindial Building', projectType: 'Design', location: 'Tanza Cavite' },
                'P15': { code: 'ALR', fullId: 'P15-ALR', clientName: 'Ms. Analou Lilang', projectName: 'Two Storey Residential Extension and Fit Out', projectType: 'Fit Out', location: 'Rizal' },
                'P16': { code: 'KLM', fullId: 'P16-KLM', clientName: 'Ms. Katrina Lopez', projectName: 'Design for 24 sqm Condo Fit Out', projectType: 'Design', location: 'Fame Residences Mandaluyong' },
                'P17': { code: 'MPN', fullId: 'P17-MPN', clientName: 'Mr. Mac Virgilio Pagaduan', projectName: 'Design for 2 Bedroom Condo Fit Out', projectType: 'Design', location: 'Vine Residences Novaliches QC' },
                'Non': { code: 'Project', fullId: 'Non-Project', clientName: 'Internal Operations', projectName: 'Company Overhead & Administrative Expenses', projectType: 'Overhead', location: 'Head Office' }
            },

            // YOUR 500 SERIES PROJECT EXPENSES
            projectExpenses: {
                '500.1': { code: '500.1', description: 'Materials', details: 'Construction supplies and delivery' },
                '500.2': { code: '500.2', description: 'Professional Fees', details: 'Architect, Engineer, Consultant, Design & Project Manager, Lead Craftsman' },
                '500.3': { code: '500.3', description: 'Labor (Outsourced)', details: 'Wages, SubCon Fees' },
                '500.4': { code: '500.4', description: 'Mobilization & Transportation', details: 'Gas, Tolls, Parking Fee and Logistics' },
                '500.5': { code: '500.5', description: 'Equipment Rental', details: 'Scaffolding, Crane' },
                '500.6': { code: '500.6', description: 'Utilities & Contingencies', details: 'Essential utilities and buffer costs during the project' },
                '500.7': { code: '500.7', description: 'Permits and Compliance', details: 'Government Permits, BIR, City Hall' },
                '500.8': { code: '500.8', description: 'Design and Admin', details: 'Technical Drawing, Admin Support' },
                '500.9': { code: '500.9', description: 'Food Allowance', details: 'Meals' },
                '500.11': { code: '500.11', description: 'Communication Allowance', details: 'Mobile Load' },
                '500.12': { code: '500.12', description: 'Others', details: 'Misc. expenses, Refund' }
            },

            // YOUR COMPLETE COA
            coa: [
                // Assets
                { oldCOA: '101', unifiedCode: '100', accountName: 'Cash in Bank', category: 'Asset', subcategory: 'Current Asset', notes: 'Funds in company\'s bank accounts' },
                { oldCOA: '102', unifiedCode: '101', accountName: 'Cash on Hand', category: 'Asset', subcategory: 'Current Asset', notes: 'Physical cash available' },
                { oldCOA: '103', unifiedCode: '102', accountName: 'Petty Cash', category: 'Asset', subcategory: 'Current Asset', notes: 'Minor cash for daily expenses' },
                { oldCOA: '104', unifiedCode: '103', accountName: 'Advance to OE', category: 'Asset', subcategory: 'Current Asset', notes: 'Advances to officers/employees' },
                { oldCOA: '105', unifiedCode: '104', accountName: 'Unliquidated Cash Advance', category: 'Asset', subcategory: 'Current Asset', notes: 'Cash advances pending liquidation' },
                { oldCOA: '106', unifiedCode: '105', accountName: 'Other Current Asset', category: 'Asset', subcategory: 'Current Asset', notes: 'Misc. short-term assets' },
                { oldCOA: '107', unifiedCode: '106', accountName: 'Creditable Tax Withheld', category: 'Asset', subcategory: 'Tax Asset', notes: 'Tax withheld by customers' },
                { oldCOA: '108', unifiedCode: '107', accountName: 'Accounts Receivable', category: 'Asset', subcategory: 'Current Asset', notes: 'Unpaid invoices from clients' },
                { oldCOA: '109', unifiedCode: '108', accountName: 'Salary Loan', category: 'Asset', subcategory: 'Current Asset', notes: 'Loan receivables from employees' },
                { oldCOA: '', unifiedCode: '109', accountName: 'Inventory', category: 'Asset', subcategory: 'Current Asset', notes: 'Raw materials for resale or use' },
                { oldCOA: '110', unifiedCode: '110', accountName: 'Tools and Equipment', category: 'Asset', subcategory: 'Non-Current Asset', notes: 'Small tools and equipment' },
                { oldCOA: '111', unifiedCode: '111', accountName: 'Property and Equipment', category: 'Asset', subcategory: 'Non-Current Asset', notes: 'Major long-term assets' },
                { oldCOA: '113', unifiedCode: '112', accountName: 'Accumulated Depreciation', category: 'Contra-Asset', subcategory: 'Non-Current Asset', notes: 'Depreciation on fixed assets' },
                { oldCOA: '117', unifiedCode: '113', accountName: 'Delivery / Service Equipment', category: 'Asset', subcategory: 'Non-Current Asset', notes: 'Vehicles/equipment for delivery' },
                
                // Liabilities
                { oldCOA: '201', unifiedCode: '200', accountName: 'Accounts Payable', category: 'Liability', subcategory: 'Current Liability', notes: 'Amounts owed to vendors' },
                { oldCOA: '', unifiedCode: '201', accountName: 'Accrued Expenses', category: 'Liability', subcategory: 'Current Liability', notes: 'Incurred but unpaid expenses' },
                { oldCOA: '', unifiedCode: '202', accountName: 'Taxes Payable', category: 'Liability', subcategory: 'Current Liability', notes: 'Outstanding tax dues' },
                { oldCOA: '', unifiedCode: '203', accountName: 'Deferred Revenue', category: 'Liability', subcategory: 'Current Liability', notes: 'Unearned revenue' },
                { oldCOA: '204', unifiedCode: '204', accountName: 'SSS Premium Payable', category: 'Liability', subcategory: 'Employee Contributions', notes: 'SSS - employer share' },
                { oldCOA: '205', unifiedCode: '205', accountName: 'Pag-ibig Premium', category: 'Liability', subcategory: 'Employee Contributions', notes: 'Pag-ibig - employer share' },
                { oldCOA: '206', unifiedCode: '206', accountName: 'Pag-ibig Loan Payable', category: 'Liability', subcategory: 'Employee Contributions', notes: 'Pag-ibig loan deductions' },
                { oldCOA: '207', unifiedCode: '207', accountName: 'Philhealth Premium', category: 'Liability', subcategory: 'Employee Contributions', notes: 'Philhealth - employer share' },
                { oldCOA: '208', unifiedCode: '208.1', accountName: 'Input VAT', category: 'Liability', subcategory: 'Taxes Payable', notes: 'VAT on purchases (claimable)' },
                { oldCOA: '', unifiedCode: '208.2', accountName: 'Output VAT', category: 'Liability', subcategory: 'Taxes Payable', notes: 'VAT collected from clients' },
                { oldCOA: '209', unifiedCode: '209', accountName: 'SSS Loan Payable', category: 'Liability', subcategory: 'Employee Contributions', notes: 'SSS loan payable' },
                { oldCOA: '210', unifiedCode: '210', accountName: 'Creditable Income Tax', category: 'Liability', subcategory: 'Taxes Payable', notes: 'Creditable portion of income tax' },
                { oldCOA: '211', unifiedCode: '211', accountName: 'Cash Refund', category: 'Liability', subcategory: 'Other Liabilities', notes: 'Refundable cash items' },
                { oldCOA: '202', unifiedCode: '212', accountName: 'Withholding Tax Payable - Expanded', category: 'Liability', subcategory: 'Taxes Payable', notes: 'EWT from suppliers' },
                { oldCOA: '', unifiedCode: '213', accountName: 'Loan Payable - Short Term', category: 'Liability', subcategory: 'Current Liability', notes: 'For loans maturing within 12 months' },
                { oldCOA: '', unifiedCode: '214', accountName: 'Loan Payable - Long Term', category: 'Liability', subcategory: 'Non-Current Liability', notes: 'For long-term loans' },
                
                // Equity
                { oldCOA: '', unifiedCode: '300', accountName: 'Capital Contribution', category: 'Equity', subcategory: 'Owner\'s Equity', notes: 'Owner investments' },
                { oldCOA: '', unifiedCode: '301', accountName: 'Retained Earnings', category: 'Equity', subcategory: 'Owner\'s Equity', notes: 'Accumulated company profit/loss' },
                { oldCOA: '', unifiedCode: '302', accountName: 'Owner\'s Drawings', category: 'Equity', subcategory: 'Withdrawals', notes: 'Withdrawals by owners' },
                
                // Revenue
                { oldCOA: '401', unifiedCode: '400', accountName: 'Service Income', category: 'Revenue', subcategory: 'Operating Revenue', notes: 'Income from main business activities' },
                { oldCOA: '', unifiedCode: '401', accountName: 'Change Order Income', category: 'Revenue', subcategory: 'Operating Revenue', notes: 'Approved variation orders' },
                { oldCOA: '404', unifiedCode: '402', accountName: 'Other Income', category: 'Revenue', subcategory: 'Non-operating Revenue', notes: 'Interest, rebates, misc. income' },
                
                // Expenses (500+ series)
                { oldCOA: '500', unifiedCode: '500', accountName: 'Direct Project Cost', category: 'Expense', subcategory: 'Project Expense', notes: 'Materials, labor, other direct project expenses' },
                { oldCOA: '301', unifiedCode: '501', accountName: 'Construction / Materials Expense', category: 'Expense', subcategory: 'Cost of Goods Sold', notes: 'Purchased materials for projects (VATable)' },
                { oldCOA: '302', unifiedCode: '502', accountName: 'Fabrication / Outsource Labor', category: 'Expense', subcategory: 'Cost of Goods Sold', notes: 'Hired labor or outsourced services (EWT)' },
                { oldCOA: '303', unifiedCode: '503', accountName: 'Company Expenses Receipt', category: 'Expense', subcategory: 'Reimbursable/Advance', notes: 'Reimbursed expenses from team' },
                { oldCOA: '312', unifiedCode: '504', accountName: 'Office Supplies', category: 'Expense', subcategory: 'Administrative Expense', notes: 'Pens, paper, ink (VATable)' },
                { oldCOA: '316', unifiedCode: '505', accountName: 'Rent Expense', category: 'Expense', subcategory: 'Administrative Expense', notes: 'Office or warehouse rent' },
                { oldCOA: '317', unifiedCode: '506', accountName: 'Utilities', category: 'Expense', subcategory: 'Administrative Expense', notes: 'Electricity, water, internet (VATable)' },
                { oldCOA: '507', unifiedCode: '507', accountName: 'Salaries and Wages', category: 'Expense', subcategory: 'Payroll Expense', notes: 'Employee payroll' },
                { oldCOA: '339', unifiedCode: '508', accountName: 'Professional Fees', category: 'Expense', subcategory: 'Administrative Expense', notes: 'Architects, consultants, etc.' },
                { oldCOA: '315', unifiedCode: '509', accountName: 'Repairs and Maintenance', category: 'Expense', subcategory: 'Operating Expense', notes: 'Office or site repairs, covers vehicles, equipment, and property upkeep' },
                { oldCOA: '332', unifiedCode: '510', accountName: 'Depreciation Expense', category: 'Expense', subcategory: 'Non-Cash Expense', notes: 'Depreciation of fixed assets' },
                { oldCOA: '327', unifiedCode: '511', accountName: 'Taxes and Licenses', category: 'Expense', subcategory: 'Compliance Expense', notes: 'Business permits, BIR, Payment to Government Agencies, Notary' },
                { oldCOA: '304', unifiedCode: '512', accountName: 'Transportation and Travel', category: 'Expense', subcategory: 'Operating Expense', notes: 'Fuel, fare, etc. (VAT-exempt or VATable)' },
                { oldCOA: '', unifiedCode: '513', accountName: 'Meals and Entertainment', category: 'Expense', subcategory: 'Operating Expense', notes: 'Client/guest meals, meetings' },
                { oldCOA: '514', unifiedCode: '514', accountName: 'Insurance Expense', category: 'Expense', subcategory: 'Operating Expense', notes: 'Insurance policies' },
                { oldCOA: '515', unifiedCode: '515', accountName: 'Training and Development', category: 'Expense', subcategory: 'Operating Expense', notes: 'Seminars, workshops, immersions' },
                { oldCOA: '328', unifiedCode: '516', accountName: 'Bank Charges', category: 'Expense', subcategory: 'Finance Expense', notes: 'Bank fees & charges' },
                { oldCOA: '314', unifiedCode: '517', accountName: 'Entertainment & Representation', category: 'Expense', subcategory: 'Administrative Expense', notes: 'Client entertainment, gifts (EWT-eligible)' },
                { oldCOA: '330', unifiedCode: '518', accountName: 'Communication - Internet', category: 'Expense', subcategory: 'Administrative Expense', notes: 'Internet subscriptions, sites and apps for communication purposes' },
                { oldCOA: '331', unifiedCode: '519', accountName: 'Communication - CP Load', category: 'Expense', subcategory: 'Administrative Expense', notes: 'Mobile load' },
                { oldCOA: '306', unifiedCode: '520', accountName: 'Parking Fee', category: 'Expense', subcategory: 'Operating Expense', notes: 'Parking tickets' },
                { oldCOA: '307', unifiedCode: '521', accountName: 'Toll Fee', category: 'Expense', subcategory: 'Operating Expense', notes: 'Tollway use' },
                { oldCOA: '305', unifiedCode: '522', accountName: 'Gasoline Expenses', category: 'Expense', subcategory: 'Operating Expense', notes: 'Gas refills' },
                { oldCOA: '309', unifiedCode: '523', accountName: 'Employee Benefits - Meals', category: 'Expense', subcategory: 'Personnel Expenses', notes: 'Meals for employees' },
                { oldCOA: '310', unifiedCode: '524', accountName: 'Employee Benefits - Uniform', category: 'Expense', subcategory: 'Personnel Expenses', notes: 'Uniform purchase' },
                { oldCOA: '311', unifiedCode: '525', accountName: 'Employee Benefits - Allowance', category: 'Expense', subcategory: 'Personnel Expenses', notes: 'Transport/housing allowance' },
                { oldCOA: '308', unifiedCode: '526', accountName: 'Employee Benefits', category: 'Expense', subcategory: 'Personnel Expenses', notes: 'Non-categorized employee benefits' },
                { oldCOA: '334', unifiedCode: '527', accountName: '13th Month Pay', category: 'Expense', subcategory: 'Personnel Expenses', notes: 'Gov\'t mandated 13th month' },
                { oldCOA: '335', unifiedCode: '528', accountName: 'Advertising Expense', category: 'Expense', subcategory: 'Marketing Expense', notes: 'Marketing & promotions' },
                { oldCOA: '324', unifiedCode: '529', accountName: 'Miscellaneous Expense', category: 'Expense', subcategory: 'Other Expenses', notes: 'Unclassified operating costs' },
                { oldCOA: '325', unifiedCode: '530', accountName: 'Interest Expense', category: 'Expense', subcategory: 'Other Expenses', notes: 'Loan interest payments' },
                { oldCOA: '326', unifiedCode: '531', accountName: 'Bad Debt Expenses', category: 'Expense', subcategory: 'Other Expenses', notes: 'Uncollected receivables' },
                { oldCOA: '329', unifiedCode: '532', accountName: 'Construction Design Expense', category: 'Expense', subcategory: 'Cost of Goods Sold', notes: 'Design-related outsourcing (EWT)' }
            ],

            // YOUR REFERENCE DATA
            operatingFunds: ['Capital', 'Infused Capital', 'Client Payments', 'Loans or Advances', 'Reinvested Profits', 'Loan - Benjo', 'Loan - Elmar'],
            expenseCategories: {
                'Overhead': 'Business-wide expenses not tied to any one project (e.g., rent, admin salaries)',
                'Project Related': 'Directly tied to a specific project (e.g., site labor, materials, subcontractors)',
                'Other': 'Rare or exceptional items (e.g., penalties, bank fees, prior period adjustments) and untraceable historical data'
            },
            expenseTypes: ['Materials', 'Labor', 'Equipment', 'Subcontractor', 'Office Supplies', 'Utilities', 'Rent', 'Professional Fees', 'Transportation', 'Communications', 'Overhead'],
            projectTypes: ['Design', 'Fit Out', 'Build', 'Renovation'],
            projectStatuses: {
                'Completed': 'All project objectives and deliverables have been successfully met. No outstanding tasks remain.',
                'On Track': 'Project is progressing according to schedule, budget, and scope with no significant issues.',
                'At Risk': 'Project is experiencing challenges that may affect scope, schedule, or budget if not mitigated.',
                'Delayed': 'Project is behind schedule due to missed milestones or extended timelines. Adjustments required.',
                'Not Pursued': 'Project was presented to the client with final plans and costing, but the client chose not to proceed. No work was started.',
                'Canceled': 'Project was formally terminated after initiation and will not continue. Work in progress has been halted.'
            },
            billingTypes: {
                'AF': 'Acceptance Fee',
                'DF': 'Design Fee', 
                'DP': 'Down Payment',
                'PB1': 'Progress Billing 1',
                'PB2': 'Progress Billing 2',
                'PB3': 'Progress Billing 3',
                'PB4': 'Progress Billing 4',
                'PB5': 'Progress Billing 5',
                'FP': 'Final Payment'
            },

            projects: [],
            transactions: [],
            collections: [],
            fixedAssets: [],
            capitalEntries: [],
            liabilityEntries: [],
            charts: {},
            calculatedData: {
                projectSummaries: {},
                monthlyData: {},
                totals: {}
            }
        };

        // Enhanced date parsing function for your format (20-Sep-21)
        function parseExcelDate(dateStr) {
            if (!dateStr) return new Date().toISOString().split('T')[0];
            
            // Handle your format: 20-Sep-21
            if (typeof dateStr === 'string' && dateStr.includes('-')) {
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const day = parts[0].padStart(2, '0');
                    const monthMap = {
                        'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 'May': '05', 'Jun': '06',
                        'Jul': '07', 'Aug': '08', 'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                    };
                    const month = monthMap[parts[1]] || '01';
                    let year = parts[2];
                    if (year.length === 2) {
                        year = parseInt(year) > 50 ? '19' + year : '20' + year;
                    }
                    return `${year}-${month}-${day}`;
                }
            }
            
            // Handle Excel date numbers
            if (typeof dateStr === 'number') {
                const date = new Date((dateStr - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            
            return new Date().toISOString().split('T')[0];
        }

        // Enhanced amount parsing function for your format (₱ 303.00)
        function parseAmount(amountStr) {
            if (typeof amountStr === 'number') return amountStr;
            if (!amountStr) return 0;
            
            // Remove currency symbols, spaces, and commas
            const cleanAmount = amountStr.toString()
                .replace(/[₱$,\s]/g, '')
                .replace(/[()]/g, '-'); // Handle negative amounts in parentheses
            
            return parseFloat(cleanAmount) || 0;
        }

        // Enhanced project lookup function
        function getProjectInfo(projectId) {
            // Try exact match first
            if (financeData.projectMaster[projectId]) {
                return financeData.projectMaster[projectId];
            }
            
            // Try to find by any part of the ID
            for (const [key, project] of Object.entries(financeData.projectMaster)) {
                if (projectId === project.fullId || projectId === project.code || projectId.includes(key)) {
                    return project;
                }
            }
            
            // Default fallback
            return {
                code: 'UNK',
                fullId: projectId,
                clientName: 'Unknown Client',
                projectName: 'Unknown Project',
                address: 'Unknown Address'
            };
        }

        // ENHANCED EXCEL IMPORT - Handles your exact format
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let importedData = false;
                    let importSummary = {
                        projects: 0,
                        transactions: 0,
                        collections: 0,
                        fixedAssets: 0
                    };
                    
                    // Process each sheet with your exact column structure
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        if (jsonData.length === 0) return;
                        
                        console.log(`Processing sheet: ${sheetName}`, jsonData[0]);
                        
                        const headers = Object.keys(jsonData[0] || {});
                        
                        // Transaction Masters - Your exact format
                        if (sheetName.toLowerCase().includes('transaction') || 
                            headers.some(h => h.toLowerCase().includes('payment date') || h.toLowerCase().includes('particulars'))) {
                            
                            financeData.transactions = jsonData.map((row, index) => {
                                // Parse your exact date format
                                const paymentDate = parseExcelDate(row['Payment Date']);
                                const month = paymentDate.slice(0, 7);
                                
                                // Parse your amount format
                                const totalAmount = parseAmount(row['Total Amount    (₱)'] || row['Total Amount'] || row['Amount']);
                                const vatableAmount = parseAmount(row['Vatable Amount  (₱)'] || row['Vatable Amount']) || (totalAmount / 1.12);
                                const vat = parseAmount(row['VAT']) || (totalAmount - vatableAmount);
                                
                                // Map your project IDs
                                const projectID = row['Project ID'] || '';
                                const projectInfo = getProjectInfo(projectID);
                                
                                // Map your COA codes
                                const oldCOACode = row['Old COA Code'] || '';
                                const unifiedCode = row['Unified Code'] || '';
                                const expenseType = row['Expense Type'] || 'General';
                                
                                return {
                                    id: Date.now() + index,
                                    paymentDate,
                                    month,
                                    particulars: row['Particulars'] || 'Transaction',
                                    expenseType,
                                    oldCOACode,
                                    unifiedCode,
                                    expenseName: row['Expense Name'] || row['COA Name'] || '',
                                    projectExpenseCode: row['Project Expense Code (500 series)'] || '',
                                    operatingFunds: row['Operating Funds'] || '',
                                    projectID,
                                    projectName: row['Project Name'] || projectInfo.projectName,
                                    vendor: row['Vendor/Supplier'] || 'Vendor',
                                    address: row['Address'] || '',
                                    quantity: parseFloat(row['Quantity']) || 1,
                                    unitPrice: parseAmount(row['Unit Price        (₱)'] || row['Unit Price']),
                                    totalAmount,
                                    vatableAmount,
                                    vat,
                                    siDrOr: row['SI/DR/OR #'] || '',
                                    paid: row['Paid (Yes/No)'] || row['Paid'] || 'No',
                                    paymentMethod: row['Payment Method'] || 'Cash Payment',
                                    notes: row['Notes'] || ''
                                };
                            });
                            
                            importedData = true;
                            importSummary.transactions = financeData.transactions.length;
                            console.log('Imported transactions:', financeData.transactions.length);
                        }
                        
                        // Collections Master - Your exact format
                        else if (sheetName.toLowerCase().includes('collection') || 
                                headers.some(h => h.toLowerCase().includes('amount received') || h.toLowerCase().includes('client name'))) {
                            
                            financeData.collections = jsonData.map((row, index) => {
                                const paymentDate = parseExcelDate(row['Date (Payment Received)'] || row['Date']);
                                const projectID = row['Project ID'] || '';
                                const projectInfo = getProjectInfo(projectID);
                                const amountReceived = parseAmount(row['Amount Received (₱)'] || row['Amount Received'] || row['Amount']);
                                
                                return {
                                    id: Date.now() + index,
                                    paymentDate,
                                    month: paymentDate.slice(0, 7),
                                    clientName: row['Client Name'] || projectInfo.clientName,
                                    projectID,
                                    projectName: row['Project Name'] || projectInfo.projectName,
                                    invoiceNumber: row['Invoice Number'] || `INV${String(index + 1).padStart(4, '0')}`,
                                    amountReceived,
                                    amountBilled: amountReceived, // Assuming received = billed for now
                                    amountPaid: amountReceived,
                                    outstandingAmount: 0,
                                    paymentMethod: row['Payment Method'] || 'CASH',
                                    coaCode: row['COA Code'] || '400',
                                    status: 'Paid',
                                    notes: row['Notes / Allocation Reference'] || row['Notes'] || ''
                                };
                            });
                            
                            importedData = true;
                            importSummary.collections = financeData.collections.length;
                            console.log('Imported collections:', financeData.collections.length);
                        }
                    });
                    
                    if (importedData) {
                        // Recalculate all data relationships
                        calculateAllData();
                        
                        // Force refresh all displays
                        setTimeout(() => {
                            renderProjectCards();
                            renderTransactions();
                            renderCollections();
                            renderReferenceTables();
                            updateDashboard();
                            
                            // Update all charts
                            Object.values(financeData.charts).forEach(chart => {
                                if (chart && chart.update) {
                                    chart.update();
                                }
                            });
                            
                            // Save to localStorage
                            autoSave();
                            
                            alert(`✅ Excel Import Successful!\n\n📊 Data Imported:\n• ${importSummary.transactions} transactions\n• ${importSummary.collections} collections\n\n🔄 All tabs and formulas have been automatically updated with your real data!\n\n💡 Your project mappings (P0-ART → Artopian, etc.) are working correctly!`);
                        }, 100);
                    } else {
                        alert('❌ No recognizable data found in the Excel file.\n\n📋 Expected sheet names:\n• Transaction Masters\n• Collections Master\n\nPlease check your Excel file format and try again.');
                    }
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert(`❌ Import Error: ${error.message}\n\n💡 Tips:\n• Ensure Excel file is not corrupted\n• Check column headers match expected format\n• Verify data types (numbers in amount columns)\n• Try saving Excel as .xlsx format`);
                }
            };
            reader.readAsArrayBuffer(file);
            
            // Clear the file input so the same file can be imported again
            event.target.value = '';
        }

        // Initialize charts
        function initializeCharts() {
            // Revenue vs Profit Chart
            const ctx1 = document.getElementById('revenueProfitChart').getContext('2d');
            financeData.charts.revenueProfitChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['2021', '2022', '2023', '2024', '2025'],
                    datasets: [{
                        label: 'Total Revenue',
                        data: [0, 0, 0, 0, 0],
                        borderColor: '#1e40af',
                        backgroundColor: 'rgba(30, 64, 175, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Total Profit',
                        data: [0, 0, 0, 0, 0],
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });

            // Monthly Profit Chart
            const ctx2 = document.getElementById('monthlyProfitChart').getContext('2d');
            financeData.charts.monthlyProfitChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Net Profit',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Budget vs Actual Chart
            const ctx3 = document.getElementById('budgetActualChart').getContext('2d');
            financeData.charts.budgetActualChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Budget',
                        data: [],
                        backgroundColor: '#0ea5e9'
                    }, {
                        label: 'Actual',
                        data: [],
                        backgroundColor: '#d97706'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // 500 Series Cost Breakdown Chart
            const ctx4 = document.getElementById('costBreakdownChart').getContext('2d');
            financeData.charts.costBreakdownChart = new Chart(ctx4, {
                type: 'pie',
                data: {
                    labels: ['Materials (500.1)', 'Professional Fees (500.2)', 'Labor (500.3)', 'Transportation (500.4)', 'Other'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#059669', '#d97706', '#0ea5e9', '#1e40af', '#dc2626']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Tab switching functionality
        function showTab(tabName) {
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'project-profile': 'Project Profile',
                'reference-table': 'Reference Table',
                'transaction-masters': 'Transaction Masters',
                'collections-master': 'Collections Master',
                'overhead-summary': 'Overhead Summary',
                'project-revenue': 'Project Revenue',
                'budget-actual': 'Budget vs Actual',
                'project-cost': 'Project Cost',
                'accounts-receivable': 'Accounts Receivable',
                'cash-flow': 'Cash Flow',
                'profit-loss': 'Profit & Loss',
                'accounts-payable': 'Accounts Payables',
                'fixed-assets': 'Fixed Assets',
                'owners-capital': 'Owners\' Capital',
                'owners-liability': 'Owners Liability',
                'balance-sheet': 'Balance Sheet',
                'trial-balance': 'Trial Balance',
                'general-ledger': 'General Ledger',
                'journal-entries': 'Journal Entries',
                'financial-reports': 'Financial Reports'
            };
            
            document.getElementById('pageTitle').textContent = titles[tabName] || 'Dashboard';
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav item
            event.target.classList.add('active');
            
            // Update data when switching to certain tabs
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'project-profile') renderProjectCards();
            if (tabName === 'reference-table') renderReferenceTables();
            if (tabName === 'transaction-masters') renderTransactions();
            if (tabName === 'collections-master') renderCollections();
        }

        // Render functions
        function renderProjectCards() {
            const container = document.getElementById('projectCards');
            const projectsFromMaster = Object.entries(financeData.projectMaster).map(([key, project]) => ({
                id: project.fullId,
                projectName: project.projectName,
                clientName: project.clientName,
                projectType: project.projectType,
                location: project.location,
                status: 'Ongoing'
            }));
            
            container.innerHTML = projectsFromMaster.map(project => {
                // Calculate project metrics from transactions and collections
                const projectTransactions = financeData.transactions.filter(t => 
                    t.projectID === project.id || t.projectID.includes(project.id.split('-')[0])
                );
                const projectCollections = financeData.collections.filter(c => 
                    c.projectID === project.id || c.projectID.includes(project.id.split('-')[0])
                );
                
                const totalExpenses = projectTransactions.filter(t => t.paid === 'Yes').reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);
                const totalCollected = projectCollections.reduce((sum, c) => sum + (parseFloat(c.amountReceived) || 0), 0);
                const profit = totalCollected - totalExpenses;
                const margin = totalCollected > 0 ? ((profit / totalCollected) * 100).toFixed(1) : 0;
                
                return `
                    <div class="glass-card rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${project.projectName}</h3>
                                <p class="text-gray-600">${project.clientName}</p>
                                <p class="text-xs text-gray-500">${project.location}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${project.projectType}
                            </span>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Project ID:</span>
                                <span class="font-medium font-mono">${project.id}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Expenses:</span>
                                <span class="font-medium text-red-600">₱${totalExpenses.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Revenue Collected:</span>
                                <span class="font-medium text-green-600">₱${totalCollected.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Net Profit:</span>
                                <span class="font-medium ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">₱${profit.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Profit Margin:</span>
                                <span class="font-medium ${margin >= 0 ? 'text-green-600' : 'text-red-600'}">${margin}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderReferenceTables() {
            renderCOATable();
            renderProjectExpenses();
            renderOperatingFunds();
            renderExpenseCategories();
            renderProjectTypes();
            renderProjectStatus();
            renderBillingTypes();
        }

        function renderOperatingFunds() {
            const container = document.getElementById('operatingFundsList');
            container.innerHTML = financeData.operatingFunds.map(fund => `
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <span class="font-medium text-blue-800">${fund}</span>
                </div>
            `).join('');
        }

        function renderExpenseCategories() {
            const container = document.getElementById('expenseCategoriesList');
            container.innerHTML = Object.entries(financeData.expenseCategories).map(([name, description]) => `
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <div class="font-semibold text-gray-800 mb-2">${name}</div>
                    <div class="text-sm text-gray-600">${description}</div>
                </div>
            `).join('');
        }

        function renderProjectTypes() {
            const container = document.getElementById('projectTypesList');
            container.innerHTML = financeData.projectTypes.map(type => `
                <div class="p-2 bg-green-50 rounded border border-green-200">
                    <span class="text-green-800 font-medium">${type}</span>
                </div>
            `).join('');
        }

        function renderProjectStatus() {
            const container = document.getElementById('projectStatusList');
            container.innerHTML = Object.entries(financeData.projectStatuses).map(([status, description]) => `
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <div class="font-semibold text-gray-800">${status}</div>
                    <div class="text-xs text-gray-600 mt-1">${description}</div>
                </div>
            `).join('');
        }

        function renderBillingTypes() {
            const container = document.getElementById('billingTypesList');
            container.innerHTML = Object.entries(financeData.billingTypes).map(([code, description]) => `
                <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="font-semibold text-purple-800">${code}</div>
                    <div class="text-sm text-purple-600">${description}</div>
                </div>
            `).join('');
        }

        function renderCOATable() {
            const tbody = document.getElementById('coaTable');
            tbody.innerHTML = financeData.coa.map(account => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-3">${account.oldCOA}</td>
                    <td class="border border-gray-200 px-4 py-3 font-medium">${account.unifiedCode}</td>
                    <td class="border border-gray-200 px-4 py-3">${account.accountName}</td>
                    <td class="border border-gray-200 px-4 py-3">${account.category}</td>
                    <td class="border border-gray-200 px-4 py-3">${account.subcategory}</td>
                    <td class="border border-gray-200 px-4 py-3 text-gray-600">${account.notes}</td>
                </tr>
            `).join('');
        }

        function renderProjectExpenses() {
            const container = document.getElementById('projectExpensesList');
            container.innerHTML = Object.values(financeData.projectExpenses).map(expense => `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-semibold text-primary">${expense.code}</span>
                        <span class="text-sm font-medium">${expense.description}</span>
                    </div>
                    <p class="text-sm text-gray-600">${expense.details}</p>
                </div>
            `).join('');
        }

        function renderTransactions() {
            const tbody = document.getElementById('transactionTable');
            tbody.innerHTML = financeData.transactions.map(transaction => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-3">${transaction.paymentDate}</td>
                    <td class="border border-gray-200 px-4 py-3">${transaction.particulars}</td>
                    <td class="border border-gray-200 px-4 py-3">${transaction.expenseType}</td>
                    <td class="border border-gray-200 px-4 py-3 font-mono">${transaction.unifiedCode}</td>
                    <td class="border border-gray-200 px-4 py-3">${transaction.projectID}</td>
                    <td class="border border-gray-200 px-4 py-3">${transaction.vendor}</td>
                    <td class="border border-gray-200 px-4 py-3 font-semibold">₱${transaction.totalAmount.toLocaleString()}</td>
                    <td class="border border-gray-200 px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${transaction.paid === 'Yes' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${transaction.paid}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function renderCollections() {
            const tbody = document.getElementById('collectionTable');
            tbody.innerHTML = financeData.collections.map(collection => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-3">${collection.paymentDate}</td>
                    <td class="border border-gray-200 px-4 py-3">${collection.clientName}</td>
                    <td class="border border-gray-200 px-4 py-3">${collection.projectID}</td>
                    <td class="border border-gray-200 px-4 py-3">${collection.projectName}</td>
                    <td class="border border-gray-200 px-4 py-3 font-mono">${collection.invoiceNumber}</td>
                    <td class="border border-gray-200 px-4 py-3 font-semibold text-green-600">₱${collection.amountReceived.toLocaleString()}</td>
                    <td class="border border-gray-200 px-4 py-3">${collection.paymentMethod}</td>
                </tr>
            `).join('');
        }

        function updateDashboard() {
            // Calculate totals from actual data
            const totalRevenue = financeData.collections.reduce((sum, c) => sum + (parseFloat(c.amountReceived) || 0), 0);
            const totalExpenses = financeData.transactions.filter(t => t.paid === 'Yes').reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);
            const netProfit = totalRevenue - totalExpenses;
            const outstandingReceivables = financeData.collections.filter(c => c.status === 'Unpaid').reduce((sum, c) => sum + (parseFloat(c.outstandingAmount) || 0), 0);
            const outstandingPayables = financeData.transactions.filter(t => t.paid === 'No').reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);
            
            document.getElementById('totalRevenue').textContent = `₱${totalRevenue.toLocaleString()}`;
            document.getElementById('totalCollections').textContent = `₱${totalRevenue.toLocaleString()}`;
            document.getElementById('totalExpenses').textContent = `₱${totalExpenses.toLocaleString()}`;
            document.getElementById('netProfit').textContent = `₱${netProfit.toLocaleString()}`;
            document.getElementById('outstandingReceivables').textContent = `₱${outstandingReceivables.toLocaleString()}`;
            document.getElementById('outstandingPayables').textContent = `₱${outstandingPayables.toLocaleString()}`;
            
            // Update 500 series cost breakdown chart
            const materials = financeData.transactions.filter(t => t.unifiedCode === '501' && t.paid === 'Yes').reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);
            const professionalFees = financeData.transactions.filter(t => t.unifiedCode === '502' && t.paid === 'Yes').reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);
            const labor = financeData.transactions.filter(t => t.unifiedCode === '503' && t.paid === 'Yes').reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);
            const transportation = financeData.transactions.filter(t => t.unifiedCode === '504' && t.paid === 'Yes').reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);
            const other = totalExpenses - materials - professionalFees - labor - transportation;
            
            financeData.charts.costBreakdownChart.data.datasets[0].data = [materials, professionalFees, labor, transportation, other];
            financeData.charts.costBreakdownChart.update();
        }

        // Automatic data calculation system
        function calculateAllData() {
            // Initialize calculated data
            financeData.calculatedData = {
                projectSummaries: {},
                monthlyData: {},
                totals: {
                    revenue: 0,
                    expenses: 0,
                    collections: 0,
                    outstanding: 0
                }
            };

            // Calculate project summaries from transactions and collections
            Object.keys(financeData.projectMaster).forEach(projectKey => {
                const project = financeData.projectMaster[projectKey];
                const projectId = project.fullId;
                
                // Get transactions for this project
                const projectTransactions = financeData.transactions.filter(t => 
                    t.projectID === projectKey || t.projectID === projectId || t.projectID === project.code
                );
                
                // Get collections for this project
                const projectCollections = financeData.collections.filter(c => 
                    c.projectID === projectKey || c.projectID === projectId || c.projectID === project.code
                );
                
                // Calculate project totals
                const totalExpenses = projectTransactions.filter(t => t.paid === 'Yes').reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);
                const totalCollected = projectCollections.reduce((sum, c) => sum + (parseFloat(c.amountReceived) || 0), 0);
                
                financeData.calculatedData.projectSummaries[projectKey] = {
                    ...project,
                    totalExpenses,
                    totalCollected,
                    profit: totalCollected - totalExpenses,
                    margin: totalCollected > 0 ? ((totalCollected - totalExpenses) / totalCollected * 100).toFixed(2) : 0
                };
            });

            // Calculate overall totals
            financeData.calculatedData.totals.revenue = financeData.collections.reduce((sum, c) => sum + (parseFloat(c.amountReceived) || 0), 0);
            financeData.calculatedData.totals.expenses = financeData.transactions.filter(t => t.paid === 'Yes').reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);
        }

        // Add/Edit functions
        function addProject() {
            const projectName = prompt('Enter project name:');
            if (!projectName) return;
            
            const clientName = prompt('Enter client name:');
            if (!clientName) return;
            
            const projectType = prompt('Enter project type (Design/Fit Out/Build/Renovation):');
            if (!projectType) return;
            
            const location = prompt('Enter project location:');
            
            // Generate next project ID
            const existingKeys = Object.keys(financeData.projectMaster).filter(k => k.startsWith('P')).map(k => parseInt(k.substring(1))).filter(n => !isNaN(n));
            const nextNum = Math.max(...existingKeys, -1) + 1;
            const projectKey = `P${nextNum}`;
            const projectCode = projectName.substring(0, 3).toUpperCase();
            const fullId = `${projectKey}-${projectCode}`;
            
            financeData.projectMaster[projectKey] = {
                code: projectCode,
                fullId: fullId,
                clientName: clientName,
                projectName: projectName,
                projectType: projectType,
                location: location || ''
            };
            
            renderProjectCards();
            autoSave();
            alert(`Project ${fullId} added successfully!`);
        }

        function addTransaction() {
            // Simple transaction form - in a real app this would be a modal
            const paymentDate = prompt('Enter payment date (YYYY-MM-DD):') || new Date().toISOString().split('T')[0];
            const particulars = prompt('Enter particulars:');
            if (!particulars) return;
            
            const amount = parseFloat(prompt('Enter amount:') || '0');
            if (amount <= 0) return;
            
            const projectID = prompt('Enter project ID (e.g., P0-ART):') || 'Non-Project';
            const vendor = prompt('Enter vendor name:') || 'Vendor';
            
            const newTransaction = {
                id: Date.now(),
                paymentDate,
                month: paymentDate.slice(0, 7),
                particulars,
                expenseType: 'General',
                oldCOACode: '',
                unifiedCode: '529',
                expenseName: 'Miscellaneous Expense',
                projectExpenseCode: '',
                operatingFunds: 'Client Payments',
                projectID,
                projectName: getProjectInfo(projectID).projectName,
                vendor,
                address: '',
                quantity: 1,
                unitPrice: amount,
                totalAmount: amount,
                vatableAmount: amount / 1.12,
                vat: amount - (amount / 1.12),
                siDrOr: '',
                paid: 'Yes',
                paymentMethod: 'Cash Payment',
                notes: ''
            };
            
            financeData.transactions.push(newTransaction);
            renderTransactions();
            updateDashboard();
            autoSave();
            alert('Transaction added successfully!');
        }

        function addCollection() {
            const paymentDate = prompt('Enter payment date (YYYY-MM-DD):') || new Date().toISOString().split('T')[0];
            const projectID = prompt('Enter project ID (e.g., P0-ART):');
            if (!projectID) return;
            
            const amount = parseFloat(prompt('Enter amount received:') || '0');
            if (amount <= 0) return;
            
            const projectInfo = getProjectInfo(projectID);
            const invoiceNumber = prompt('Enter invoice number:') || `INV${Date.now()}`;
            
            const newCollection = {
                id: Date.now(),
                paymentDate,
                month: paymentDate.slice(0, 7),
                clientName: projectInfo.clientName,
                projectID,
                projectName: projectInfo.projectName,
                invoiceNumber,
                amountReceived: amount,
                amountBilled: amount,
                amountPaid: amount,
                outstandingAmount: 0,
                paymentMethod: 'CASH',
                coaCode: '400',
                status: 'Paid',
                notes: ''
            };
            
            financeData.collections.push(newCollection);
            renderCollections();
            updateDashboard();
            autoSave();
            alert('Collection added successfully!');
        }

        function addCOA() {
            const accountName = prompt('Enter account name:');
            if (!accountName) return;
            
            const unifiedCode = prompt('Enter unified code:');
            if (!unifiedCode) return;
            
            const category = prompt('Enter category (Asset/Liability/Equity/Revenue/Expense):');
            if (!category) return;
            
            const subcategory = prompt('Enter subcategory:') || '';
            const notes = prompt('Enter notes:') || '';
            
            financeData.coa.push({
                oldCOA: '',
                unifiedCode,
                accountName,
                category,
                subcategory,
                notes
            });
            
            renderCOATable();
            autoSave();
            alert('COA account added successfully!');
        }

        function addFixedAsset() {
            alert('Fixed Asset form will be implemented here');
        }

        function addCapitalEntry() {
            alert('Capital Entry form will be implemented here');
        }

        function addLiabilityEntry() {
            alert('Liability Entry form will be implemented here');
        }

        function addJournalEntry() {
            alert('Journal Entry form will be implemented here');
        }

        // Utility functions
        function importExcel() {
            document.getElementById('excelFileInput').click();
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            
            // Create worksheets for each data type
            const transactionWS = XLSX.utils.json_to_sheet(financeData.transactions);
            const collectionWS = XLSX.utils.json_to_sheet(financeData.collections);
            
            // Add worksheets to workbook
            XLSX.utils.book_append_sheet(wb, transactionWS, "Transaction Masters");
            XLSX.utils.book_append_sheet(wb, collectionWS, "Collections Master");
            
            // Generate and download file
            const fileName = `Prospira_Finance_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function editCompanyName() {
            const newName = prompt('Enter company name:', financeData.companyName === 'Click to set company name' ? '' : financeData.companyName);
            if (newName && newName.trim()) {
                financeData.companyName = newName.trim();
                document.getElementById('companyName').textContent = financeData.companyName;
                autoSave();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function autoSave() {
            calculateAllData();
            try {
                localStorage.setItem('prospiraFinanceData', JSON.stringify(financeData));
                showAutoSaveNotification();
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function showAutoSaveNotification() {
            const notification = document.getElementById('autoSaveNotification');
            notification.style.transform = 'translateY(0)';
            setTimeout(() => {
                notification.style.transform = 'translateY(100%)';
            }, 2000);
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('prospiraFinanceData');
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    financeData = { ...financeData, ...parsedData };
                    document.getElementById('companyName').textContent = financeData.companyName;
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        // Initialize the application
        function initializeApp() {
            loadFromLocalStorage();
            calculateAllData();
            initializeCharts();
            renderProjectCards();
            renderReferenceTables();
            renderTransactions();
            renderCollections();
            updateDashboard();
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97356303353dedbe',t:'MTc1NTg5NzMzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
